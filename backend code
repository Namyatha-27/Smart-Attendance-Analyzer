from flask import Flask, render_template, request
import face_recognition
import os
import pandas as pd
from datetime import datetime

app = Flask(__name__)

KNOWN_FACES_DIR = "dataset/students"
UPLOAD_DIR = "uploads"
ATTENDANCE_FILE = "attendance/attendance.csv"

known_encodings = []
known_names = []

# Load known student images
for file in os.listdir(KNOWN_FACES_DIR):
    image_path = os.path.join(KNOWN_FACES_DIR, file)
    image = face_recognition.load_image_file(image_path)

    encodings = face_recognition.face_encodings(image)
    if len(encodings) > 0:
        known_encodings.append(encodings[0])
        name = file.split("_")[1].split(".")[0]
        known_names.append(name)

@app.route("/", methods=["GET", "POST"])
def index():
    present_students = []

    if request.method == "POST":
        image_file = request.files["image"]
        image_path = os.path.join(UPLOAD_DIR, image_file.filename)
        image_file.save(image_path)

        uploaded_image = face_recognition.load_image_file(image_path)
        face_locations = face_recognition.face_locations(uploaded_image)
        face_encodings = face_recognition.face_encodings(uploaded_image, face_locations)

        for face_encoding in face_encodings:
            matches = face_recognition.compare_faces(known_encodings, face_encoding)

            if True in matches:
                index_match = matches.index(True)
                name = known_names[index_match]
                if name not in present_students:
                    present_students.append(name)

        if present_students:
            date = datetime.now().strftime("%d-%m-%Y")
            df = pd.DataFrame({
                "Date": [date] * len(present_students),
                "Name": present_students
            })
            df.to_csv(ATTENDANCE_FILE, mode="a", header=False, index=False)

    return render_template("index.html", students=present_students)

if __name__ == "__main__":
    app.run(debug=True)
